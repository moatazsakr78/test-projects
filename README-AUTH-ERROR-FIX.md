# إصلاح مشكلة "Database error granting user" في Supabase

## المشكلة

عند محاولة تسجيل الدخول أو إنشاء حساب جديد في تطبيق يستخدم Supabase، تظهر رسالة الخطأ التالية:

```
Database error granting user
```

هذه المشكلة تحدث عادة بسبب مشكلة في صلاحيات الوصول (permissions) في قاعدة البيانات، وليست بسبب سياسات Row Level Security (RLS) فقط. قد تستمر المشكلة حتى بعد تعطيل RLS على جداول المستخدمين.

## أسباب المشكلة

تحدث هذه المشكلة بسبب واحد أو أكثر من الأسباب التالية:

1. **نقص صلاحيات الوصول للمستخدم المجهول (anon)**:
   - قد لا يملك المستخدم المجهول (anon) صلاحية USAGE على مخطط auth
   - قد لا يملك المستخدم المجهول (anon) صلاحية SELECT على جدول auth.users

2. **مشكلة في تكوين نظام المصادقة (auth system)**:
   - خطأ في إعدادات JWT
   - مشكلة في تهيئة خدمة auth في Supabase

3. **مشكلة في تكوين RLS على جداول المستخدمين**:
   - قد تكون هناك سياسات RLS خاطئة على جدول auth.users أو public.users
   - قد تكون هناك تضاربات في سياسات RLS

## الحلول

### الحل 1: تشخيص وإصلاح المشكلة تلقائيًا (موصى به)

1. قم بتشغيل ملف `fix-auth-error.bat` واختر الخيار 1 لتشخيص المشكلة
2. سيقوم السكريبت بمحاولة إنشاء حساب اختباري وتحديد سبب المشكلة
3. ثم سيقوم بتطبيق الإصلاحات المناسبة

### الحل 2: تطبيق الإصلاح المباشر

1. قم بتسجيل الدخول إلى لوحة تحكم Supabase
2. انتقل إلى صفحة SQL Editor
3. انسخ محتوى أحد ملفات SQL التالية وألصقه في المحرر:
   - `direct-auth-fix.sql` (إصلاح مبسط)
   - `fix-auth-permissions.sql` (إصلاح شامل)
4. اضغط على زر "Run" لتنفيذ الأوامر

### الحل 3: تطبيق الإصلاح يدويًا

إذا كنت تفضل الإصلاح اليدوي، قم بتنفيذ الأوامر التالية في SQL Editor:

```sql
-- إصلاح مشكلة صلاحيات المستخدم المجهول
GRANT USAGE ON SCHEMA auth TO anon;
GRANT SELECT ON TABLE auth.users TO anon;

-- إصلاح مشكلة صلاحيات المستخدم المصادق عليه
GRANT USAGE ON SCHEMA auth TO authenticated;
GRANT SELECT ON TABLE auth.users TO authenticated;

-- تعطيل RLS على جداول المستخدمين
ALTER TABLE IF EXISTS auth.users DISABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS public.users DISABLE ROW LEVEL SECURITY;
```

## تفاصيل الملفات المتاحة

1. **test-auth.js**:
   - سكريبت تشخيص يحاول إنشاء حساب جديد وتسجيل الدخول
   - يقوم بتشخيص مشكلة الصلاحيات بدقة

2. **fix-auth-permissions.sql**:
   - ملف SQL شامل يصلح جميع مشكلات الصلاحيات المتعلقة بالمصادقة
   - يمنح الصلاحيات المناسبة لكل من anon و authenticated و service_role

3. **direct-auth-fix.sql**:
   - ملف SQL مبسط يحتوي على الأوامر الأساسية فقط
   - مناسب للتطبيق السريع

4. **fix-auth-error.bat**:
   - ملف تشغيل يوفر واجهة لتشخيص وإصلاح المشكلة
   - يقدم إرشادات مفصلة لكيفية تطبيق الإصلاح

## كيفية التحقق من نجاح الإصلاح

بعد تطبيق الإصلاح، اختبر عملية المصادقة بإحدى الطرق التالية:

1. **من خلال واجهة تطبيقك**:
   - حاول إنشاء حساب جديد
   - حاول تسجيل الدخول بحساب موجود

2. **باستخدام سكريبت الاختبار**:
   - قم بتشغيل `node test-auth.js` لإجراء اختبار تلقائي

## ملاحظات هامة

- **إعادة تشغيل الخدمة**: في بعض الحالات، قد تحتاج إلى إعادة تشغيل خدمة Supabase Auth من خلال لوحة التحكم.
- **تأكد من تحديث Supabase**: تأكد من أن مشروع Supabase محدث لأحدث إصدار.
- **احذر من التعديلات السابقة**: إذا كنت قد أجريت تعديلات يدوية على نظام المصادقة، فقد تحتاج إلى مراجعتها.

## الأسئلة الشائعة

### هل هذا الإصلاح آمن لبيئة الإنتاج؟
نعم، تعد الإصلاحات المقدمة آمنة لبيئة الإنتاج. إنها تعيد ضبط الصلاحيات إلى حالتها الطبيعية التي يجب أن تكون عليها في مشروع Supabase.

### هل ستؤثر هذه التغييرات على البيانات الموجودة؟
لا، هذه التغييرات تؤثر فقط على صلاحيات الوصول وليست على البيانات نفسها.

### هل أحتاج إلى عمل نسخة احتياطية قبل التنفيذ؟
من الجيد دائمًا عمل نسخة احتياطية قبل أي تغييرات في قاعدة البيانات، ولكن هذه التغييرات لا تمس البيانات نفسها.

### ماذا أفعل إذا استمرت المشكلة بعد تطبيق الإصلاح؟
إذا استمرت المشكلة، حاول:
- إعادة تشغيل خدمة Supabase Auth من لوحة التحكم
- التحقق من سجلات الخطأ في Supabase
- التواصل مع دعم Supabase إذا استمرت المشكلة

## للمزيد من المساعدة

إذا كنت بحاجة إلى مزيد من المساعدة، يمكنك:
- مراجعة [توثيق نظام المصادقة في Supabase](https://supabase.com/docs/guides/auth)
- الاطلاع على [مجتمع Supabase على GitHub](https://github.com/supabase/supabase/discussions)
- مراجعة سجلات الخطأ في لوحة تحكم Supabase للحصول على معلومات أكثر تفصيلاً 