# حل مشكلة "Database error granting user" في Supabase

## نظرة عامة على المشكلة

تحدث مشكلة "Database error granting user" عند محاولة تسجيل الدخول أو إنشاء حساب جديد في تطبيق يستخدم Supabase. المشكلة ناتجة عن واحد أو أكثر من الأسباب التالية:

1. **نقص في صلاحيات الوصول للمستخدم المجهول (anon)**:
   - عدم وجود صلاحية USAGE على مخطط auth
   - عدم وجود صلاحية SELECT على جدول auth.users

2. **مشكلات في سياسات Row Level Security (RLS)**:
   - سياسات متداخلة أو غير صحيحة تسبب تكرارًا لانهائيًا
   - سياسات متضاربة على جداول المستخدمين

3. **إعدادات أمان غير صحيحة في قاعدة البيانات**

## الحل المطبق

لقد قمنا بإنشاء حل شامل يعالج جميع هذه المشكلات من خلال الملفات التالية:

### 1. ملف `auth-fix-applied.sql`

هذا الملف يحتوي على جميع أوامر SQL اللازمة لإصلاح المشكلة، وتشمل:

- منح صلاحيات الوصول المناسبة للأدوار المختلفة (anon, authenticated, service_role)
- تعطيل سياسات RLS على جداول المستخدمين التي تسبب المشكلة
- حذف سياسات RLS المتداخلة أو المتضاربة
- إعادة إعداد وظائف auth الأساسية بشكل صحيح

### 2. ملف `test-auth-fixed.js`

سكريبت Node.js لاختبار عملية المصادقة بعد تطبيق الإصلاحات، يقوم بـ:

- اختبار إنشاء حساب جديد (تسجيل)
- اختبار تسجيل الدخول بحساب موجود
- عرض تقرير مفصل عن نتائج الاختبارات

### 3. ملف `apply-auth-fix.bat`

سكريبت باتش يسهل عملية تطبيق الإصلاحات واختبار النتائج، يوفر:

- عرض ملف الإصلاح SQL وإرشادات تطبيقه
- تشغيل اختبارات المصادقة بعد تطبيق الإصلاح
- تثبيت الوحدات المطلوبة عند الحاجة

## كيفية استخدام الحل

1. قم بتشغيل ملف `apply-auth-fix.bat`
2. اختر الخيار 1 لعرض ملف الإصلاح SQL
3. اتبع الإرشادات لتطبيق الإصلاح على قاعدة بيانات Supabase
4. عد إلى السكريبت واختر الخيار 2 لاختبار الإصلاح

## الإصلاحات الرئيسية

### 1. إصلاح صلاحيات المستخدم المجهول

```sql
GRANT USAGE ON SCHEMA auth TO anon;
GRANT SELECT ON TABLE auth.users TO anon;
```

### 2. تعطيل RLS على جداول المستخدمين

```sql
ALTER TABLE IF EXISTS auth.users DISABLE ROW LEVEL SECURITY;
ALTER TABLE IF EXISTS public.users DISABLE ROW LEVEL SECURITY;
```

### 3. حذف سياسات RLS المتضاربة

```sql
DROP POLICY IF EXISTS "Users can view own data" ON "users";
DROP POLICY IF EXISTS "Users can update own data" ON "users";
-- وغيرها من السياسات المتداخلة
```

## ملاحظات هامة

- بعد تطبيق هذا الإصلاح، ستعمل المصادقة في تطبيقك بشكل صحيح، لكن احرص على فهم آثار تعطيل RLS على أمان تطبيقك.
- في بيئة الإنتاج، ربما تحتاج إلى إعادة تفعيل سياسات RLS بشكل صحيح بعد إصلاح المشكلة.
- تأكد من اختبار النظام بشكل كامل بعد تطبيق الإصلاحات.

## الخطوات المستقبلية

بعد تطبيق هذا الإصلاح والتأكد من عمل المصادقة بشكل صحيح، قد ترغب في:

1. **إعادة تفعيل سياسات RLS** بشكل آمن وصحيح بدون تداخل
2. **تحسين أمان البيانات** من خلال تطبيق سياسات RLS مناسبة لتطبيقك
3. **إعداد نظام مراقبة** للتنبيه في حالة حدوث مشكلات مستقبلية في المصادقة

## للمساعدة والدعم الإضافي

إذا واجهتك مشكلات أخرى في نظام المصادقة، يرجى:

- مراجعة [توثيق Supabase للمصادقة](https://supabase.com/docs/guides/auth)
- الاطلاع على [مجتمع Supabase على GitHub](https://github.com/supabase/supabase/discussions) 