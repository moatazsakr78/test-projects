# إصلاح مشكلات تسجيل الدخول وإنشاء الحسابات المتعلقة بسياسات RLS

## المشكلة

في تطبيقات Supabase، قد تظهر مشكلات عند محاولة تسجيل الدخول أو إنشاء حسابات جديدة بسبب سياسات Row Level Security (RLS). هذه المشكلات تشمل:

1. **تكرار لا نهائي (Infinite recursion)**: تظهر رسالة خطأ `infinite recursion detected in policy for relation users` عند محاولة الوصول إلى جدول المستخدمين.
2. **منع عمليات الإدراج/التحديث**: سياسات RLS المعيبة يمكن أن تمنع عمليات إنشاء حسابات جديدة أو تحديث بيانات المستخدمين.
3. **فشل عملية التحقق**: المستخدمون قد يتمكنون من التسجيل لكن لا يمكنهم تسجيل الدخول لاحقًا.

## الحلول

### الحل 1: تطبيق سياسات RLS المصححة (الحل المفضل)

قمنا بإنشاء ملف `fix-users-rls.sql` الذي يقوم بإعادة ضبط سياسات RLS لجدول المستخدمين بطريقة صحيحة:

1. حذف السياسات المتضاربة القديمة
2. تعطيل RLS مؤقتًا لإصلاح المشكلة
3. إعادة تفعيل RLS مع سياسات بسيطة وآمنة تتيح:
   - للمستخدمين المجهولين التسجيل
   - للمستخدمين المسجلين الوصول إلى حساباتهم
   - للمستخدمين تحديث بياناتهم الخاصة فقط

#### خطوات تطبيق الحل:

**الطريقة 1: استخدام واجهة Supabase SQL (طريقة يدوية)**:

1. قم بتسجيل الدخول إلى لوحة تحكم Supabase
2. انتقل إلى قسم SQL Editor
3. انسخ محتوى ملف `fix-users-rls.sql` 
4. ألصق المحتوى في محرر SQL واضغط على Run

**الطريقة 2: استخدام سكريبت الإصلاح التلقائي**:

1. قم بتشغيل ملف `fix-auth-rls.bat` للحصول على إرشادات التنفيذ
2. أو قم بتشغيل `node fix-auth-rls.js` إذا كنت تفضل استخدام JavaScript

### الحل 2: تعطيل RLS بالكامل (حل مؤقت)

إذا كنت بحاجة إلى حل سريع، يمكنك تعطيل RLS بالكامل على جدول المستخدمين:

1. قم بتنفيذ ملف `simple-disable-rls.sql` مباشرة من خلال محرر SQL في Supabase
2. أو قم بتنفيذ السطرين التاليين فقط:

```sql
DROP POLICY IF EXISTS "Users can view own data" ON "users";
ALTER TABLE "users" DISABLE ROW LEVEL SECURITY;
```

> ⚠️ **تحذير**: هذا الحل ليس آمنًا للإنتاج لأنه يزيل الحماية التي توفرها سياسات RLS. استخدمه فقط كحل مؤقت في بيئة التطوير.

## تفاصيل سياسات RLS الجديدة

سياسات RLS الجديدة المطبقة في الحل المفضل:

```sql
-- السماح للمستخدمين المجهولين بالتسجيل
CREATE POLICY "Allow anonymous users to register"
ON "users" FOR INSERT
TO anon
WITH CHECK (true);

-- السماح للمستخدمين المسجلين بتسجيل الدخول
CREATE POLICY "Allow all authenticated users to sign in" 
ON "users" FOR SELECT 
TO authenticated 
USING (true);

-- سياسة للقراءة
CREATE POLICY "Allow users to view their own profile"
ON "users" FOR SELECT
USING (
  id = auth.uid()
);

-- سياسة للتحديث
CREATE POLICY "Allow users to update their own profile"
ON "users" FOR UPDATE
USING (
  id = auth.uid()
);
```

هذه السياسات توفر:
1. إمكانية تسجيل مستخدمين جدد
2. إمكانية تسجيل الدخول للمستخدمين المسجلين
3. حماية بيانات المستخدمين بحيث يمكن لكل مستخدم الوصول إلى بياناته فقط

## التحقق من نجاح الإصلاح

بعد تطبيق الإصلاح، يمكنك التحقق من نجاحه من خلال:

1. محاولة تسجيل حساب جديد
2. محاولة تسجيل الدخول بحساب موجود
3. التحقق من عدم ظهور رسائل خطأ تتعلق بـ "infinite recursion" أو سياسات RLS

## ملاحظات إضافية

- تأكد من أن تطبيق الويب يستخدم إصدار حديث من مكتبة `@supabase/supabase-js`
- إذا كنت تستخدم جدول `profiles` منفصل عن جدول `users`، قد تحتاج إلى تطبيق إصلاحات مماثلة على هذا الجدول أيضًا
- إذا استمرت المشكلة بعد تطبيق الحلول، تحقق من سجلات الخطأ في لوحة تحكم Supabase لمزيد من التفاصيل

## لمزيد من المساعدة

إذا واجهت مشكلات إضافية، يمكنك:

- الاطلاع على توثيق Supabase الرسمي حول [سياسات RLS](https://supabase.com/docs/guides/auth/row-level-security)
- الرجوع إلى ملف `README-RLS-FIX.md` للحصول على مزيد من المعلومات حول إصلاح سياسات RLS
- تنفيذ الخطوات اليدوية في الحل الأول إذا لم تنجح السكريبتات التلقائية 